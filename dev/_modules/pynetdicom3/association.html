

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pynetdicom3.association &mdash; pynetdicom3 0.9.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/pynetdicom3.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/pynetdicom3.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pynetdicom3
          

          
            
            <img src="../../_static/pydicom_flat_black.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ae_intro.html">ApplicationEntity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../assoc_intro.html">Introduction to Association</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Package documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pynetdicom3</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pynetdicom3.association</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pynetdicom3.association</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines the Association class which handles associating with peers.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">pydicom.dataset</span> <span class="k">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">pydicom.uid</span> <span class="k">import</span> <span class="n">UID</span>

<span class="c1"># pylint: disable=no-name-in-module</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.acse</span> <span class="k">import</span> <span class="n">ACSEServiceProvider</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.dimse</span> <span class="k">import</span> <span class="n">DIMSEServiceProvider</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.dimse_primitives</span> <span class="k">import</span> <span class="p">(</span><span class="n">C_ECHO</span><span class="p">,</span> <span class="n">C_MOVE</span><span class="p">,</span> <span class="n">C_STORE</span><span class="p">,</span> <span class="n">C_GET</span><span class="p">,</span>
                                          <span class="n">C_FIND</span><span class="p">,</span> <span class="n">C_CANCEL</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.dsutils</span> <span class="k">import</span> <span class="n">decode</span><span class="p">,</span> <span class="n">encode</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.dul</span> <span class="k">import</span> <span class="n">DULServiceProvider</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.sop_class</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">uid_to_sop_class</span><span class="p">,</span>
    <span class="n">ModalityWorklistInformationFind</span><span class="p">,</span>
    <span class="n">PatientRootQueryRetrieveInformationModelFind</span><span class="p">,</span>
    <span class="n">StudyRootQueryRetrieveInformationModelFind</span><span class="p">,</span>
    <span class="n">PatientStudyOnlyQueryRetrieveInformationModelFind</span><span class="p">,</span>
    <span class="n">PatientRootQueryRetrieveInformationModelMove</span><span class="p">,</span>
    <span class="n">StudyRootQueryRetrieveInformationModelMove</span><span class="p">,</span>
    <span class="n">PatientStudyOnlyQueryRetrieveInformationModelMove</span><span class="p">,</span>
    <span class="n">PatientRootQueryRetrieveInformationModelGet</span><span class="p">,</span>
    <span class="n">StudyRootQueryRetrieveInformationModelGet</span><span class="p">,</span>
    <span class="n">PatientStudyOnlyQueryRetrieveInformationModelGet</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.pdu_primitives</span> <span class="k">import</span> <span class="p">(</span><span class="n">UserIdentityNegotiation</span><span class="p">,</span>
                                        <span class="n">SOPClassExtendedNegotiation</span><span class="p">,</span>
                                        <span class="n">SOPClassCommonExtendedNegotiation</span><span class="p">,</span>
                                        <span class="n">A_ASSOCIATE</span><span class="p">,</span> <span class="n">A_ABORT</span><span class="p">,</span> <span class="n">A_P_ABORT</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.status</span> <span class="k">import</span> <span class="p">(</span><span class="n">code_to_status</span><span class="p">,</span> <span class="n">code_to_category</span><span class="p">,</span>
                                <span class="n">STORAGE_SERVICE_CLASS_STATUS</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pynetdicom3.utils</span> <span class="k">import</span> <span class="n">PresentationContextManager</span>
<span class="c1"># pylint: enable=no-name-in-module</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pynetdicom3.assoc&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Association"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association">[docs]</a><span class="k">class</span> <span class="nc">Association</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manages Associations with peer AEs.</span>

<span class="sd">    The actual low level work done for Associations is performed by</span>
<span class="sd">    pynetdicom3.acse.ACSEServiceProvider.</span>

<span class="sd">    When the local AE is acting as an SCP, initialise the Association using</span>
<span class="sd">    the socket to listen on for incoming Association requests. When the local</span>
<span class="sd">    AE is acting as an SCU, initialise the Association with the details of the</span>
<span class="sd">    peer AE.</span>

<span class="sd">    When AE is acting as an SCP:</span>
<span class="sd">        assoc = Association(client_socket, max_pdu)</span>

<span class="sd">    When AE is acting as an SCU:</span>
<span class="sd">        assoc = Association(peer_ae, acse_timeout, dimse_timeout,</span>
<span class="sd">                            max_pdu, ext_neg)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    acse : ACSEServiceProvider</span>
<span class="sd">        The Association Control Service Element provider.</span>
<span class="sd">    ae : pynetdicom3.applicationentity.ApplicationEntity</span>
<span class="sd">        The local AE.</span>
<span class="sd">    dimse : DIMSEServiceProvider</span>
<span class="sd">        The DICOM Message Service Element provider.</span>
<span class="sd">    dul : DUL</span>
<span class="sd">        The DICOM Upper Layer service provider instance.</span>
<span class="sd">    is_aborted : bool</span>
<span class="sd">        True if the association has been aborted, False otherwise.</span>
<span class="sd">    is_established : bool</span>
<span class="sd">        True if the association has been established, False otherwise.</span>
<span class="sd">    is_rejected : bool</span>
<span class="sd">        True if the association was rejected, False otherwise.</span>
<span class="sd">    is_released : bool</span>
<span class="sd">        True if the association has been released, False otherwise.</span>
<span class="sd">    local_ae : dict</span>
<span class="sd">        The local Application Entity details, keys: &#39;port&#39;, &#39;address&#39;,</span>
<span class="sd">        &#39;ae_title&#39;, &#39;pdv_size&#39;.</span>
<span class="sd">    mode : str</span>
<span class="sd">        Whether the local AE is acting as the Association &#39;Requestor&#39; or</span>
<span class="sd">        &#39;Acceptor&#39; (i.e. SCU or SCP).</span>
<span class="sd">    peer_ae : dict</span>
<span class="sd">        The peer Application Entity details, keys: &#39;port&#39;, &#39;address&#39;,</span>
<span class="sd">        &#39;ae_title&#39;, &#39;pdv_size&#39;.</span>
<span class="sd">    client_socket : socket.socket</span>
<span class="sd">        The socket to use for connections with the peer AE.</span>
<span class="sd">    scu_supported_sop : list of pynetdicom3.sop_class.ServiceClass</span>
<span class="sd">        A list of the supported SOP classes when acting as an SCU.</span>
<span class="sd">    scp_supported_sop : list of pynetdicom3.sop_class.ServiceClass</span>
<span class="sd">        A list of the supported SOP classes when acting as an SCP.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_ae</span><span class="p">,</span> <span class="n">client_socket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peer_ae</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">acse_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">dimse_timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_pdu</span><span class="o">=</span><span class="mi">16382</span><span class="p">,</span>
                 <span class="n">ext_neg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Association.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        local_ae : pynetdicom3.applicationentity.ApplicationEntity</span>
<span class="sd">            The local AE instance.</span>
<span class="sd">        client_socket : socket.socket or None, optional</span>
<span class="sd">            If the local AE is acting as an SCP, this is the listen socket for</span>
<span class="sd">            incoming connection requests. A value of None is used when acting</span>
<span class="sd">            as an SCU.</span>
<span class="sd">        peer_ae : dict, optional</span>
<span class="sd">            If the local AE is acting as an SCU this is the AE title, host and</span>
<span class="sd">            port of the peer AE that we want to Associate with. Keys: &#39;port&#39;,</span>
<span class="sd">            &#39;address&#39;, &#39;ae_title&#39;.</span>
<span class="sd">        acse_timeout : int, optional</span>
<span class="sd">            The maximum amount of time to wait for a reply during association,</span>
<span class="sd">            in seconds. A value of 0 means no timeout (default: 30).</span>
<span class="sd">        dimse_timeout : int, optional</span>
<span class="sd">            The maximum amount of time to wait for a reply during DIMSE, in</span>
<span class="sd">            seconds. A value of 0 means no timeout (default: 0).</span>
<span class="sd">        max_pdu : int, optional</span>
<span class="sd">            The maximum PDU receive size in bytes for the association. A value</span>
<span class="sd">            of 0 means no maximum size (default: 16382 bytes).</span>
<span class="sd">        ext_neg : list of extended negotiation parameters objects, optional</span>
<span class="sd">            If the association requires an extended negotiation then `ext_neg`</span>
<span class="sd">            is a list containing the negotiation objects (default: None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;port&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;address&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;ae_title&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;pdv_size&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># Why is the AE in charge of supplying the client socket?</span>
        <span class="c1">#   Hmm, perhaps because we can have multiple connections on the same</span>
        <span class="c1">#       listen port. Does that even work? Probably needs testing</span>
        <span class="c1">#   As SCP: supply port number to listen on (listen_port != None)</span>
        <span class="c1">#   As SCU: supply addr/port to make connection on (peer_ae != None)</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">peer_ae</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Association must be initialised with either &quot;</span>
                            <span class="s2">&quot;the client_socket or peer_ae parameters&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">client_socket</span> <span class="ow">and</span> <span class="n">peer_ae</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Association must be initialised with either &quot;</span>
                            <span class="s2">&quot;client_socket or peer_ae parameter not both&quot;</span><span class="p">)</span>

        <span class="c1"># Received a connection from a peer AE</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;Acceptor&#39;</span>
        <span class="k">elif</span> <span class="n">client_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;client_socket must be a socket.socket&quot;</span><span class="p">)</span>

        <span class="c1"># Initiated a connection to a peer AE</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">peer_ae</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s1">&#39;Requestor&#39;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ae_title&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">peer_ae</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;peer_ae must contain &#39;ae_title&#39;, &#39;port&#39; &quot;</span>
                                   <span class="s2">&quot;and &#39;address&#39; entries&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">peer_ae</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">peer_ae</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;peer_ae must be a dict&quot;</span><span class="p">)</span>

        <span class="c1"># The socket.socket used for connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_socket</span> <span class="o">=</span> <span class="n">client_socket</span>

        <span class="c1"># The parent AE object</span>
        <span class="kn">from</span> <span class="nn">pynetdicom3</span> <span class="k">import</span> <span class="n">AE</span> <span class="c1"># Imported here to avoid circular import</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">local_ae</span><span class="p">,</span> <span class="n">AE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">local_ae</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;local_ae must be a pynetdicom3.AE&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;port&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;address&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="s1">&#39;ae_title&#39;</span> <span class="p">:</span> <span class="n">local_ae</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,</span>
                         <span class="s1">&#39;pdv_size&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># Why do we instantiate the DUL provider with a socket when acting</span>
        <span class="c1">#   as an SCU?</span>
        <span class="c1"># Q. Why do we need to feed the DUL an ACSE timeout?</span>
        <span class="c1"># A. ARTIM timer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dul</span> <span class="o">=</span> <span class="n">DULServiceProvider</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">client_socket</span><span class="p">,</span>
                                      <span class="n">dul_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">network_timeout</span><span class="p">,</span>
                                      <span class="n">assoc</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Lists of pynetdicom3.utils.PresentationContext items that the local</span>
        <span class="c1">#   AE supports when acting as an SCU and SCP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scp_supported_sop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scu_supported_sop</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Status attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_rejected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_released</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Timeouts for the DIMSE and ACSE service providers</span>
        <span class="k">if</span> <span class="n">dimse_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimse_timeout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dimse_timeout</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimse_timeout</span> <span class="o">=</span> <span class="n">dimse_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;dimse_timeout must be numeric or None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">acse_timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse_timeout</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">acse_timeout</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse_timeout</span> <span class="o">=</span> <span class="n">acse_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;acse_timeout must be numeric or None&quot;</span><span class="p">)</span>

        <span class="c1"># Maximum PDU sizes (in bytes) for the local and peer AE</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_pdu</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;pdv_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_pdu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_max_pdu</span> <span class="o">=</span> <span class="n">max_pdu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;max_pdu must be an int&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_max_pdu</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># A list of extended negotiation objects</span>
        <span class="n">ext_neg</span> <span class="o">=</span> <span class="n">ext_neg</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext_neg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_neg</span> <span class="o">=</span> <span class="n">ext_neg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ext_neg must be a list of Extended &quot;</span>
                            <span class="s2">&quot;Negotiation items or None&quot;</span><span class="p">)</span>

        <span class="c1"># Set new ACSE and DIMSE providers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span> <span class="o">=</span> <span class="n">ACSEServiceProvider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse_timeout</span><span class="p">)</span>
        <span class="c1"># FIXME: DIMSE max pdu should be the peer max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span> <span class="o">=</span> <span class="n">DIMSEServiceProvider</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse_timeout</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">local_max_pdu</span><span class="p">)</span>

        <span class="c1"># Kills the thread loop in run()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Send an A-ABORT when an association request is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a_abort_assoc_rq</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Send an A-P-ABORT when an association request is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a_p_abort_assoc_rq</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Disconnect from the peer when an association request is received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_assoc_rq</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Point the public send_c_cancel_* functions to the actual function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_c_cancel_find</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_c_cancel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_c_cancel_move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_c_cancel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_c_cancel_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_c_cancel</span>

        <span class="c1"># Thread setup</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Association.kill"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.kill">[docs]</a>    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kill the main association thread loop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">stop_dul</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">cleanup_associations</span><span class="p">()</span></div>

<div class="viewcode-block" id="Association.release"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release the association.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">release_assoc</span><span class="p">():</span>
                <span class="c1"># Got release reply within timeout window</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_released</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No release reply within timeout window</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span></div>

<div class="viewcode-block" id="Association.abort"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.abort">[docs]</a>    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Abort the association.</span>

<span class="sd">        DUL service user association abort. Always gives the source as the</span>
<span class="sd">        DUL service user and sets the abort reason to 0x00 (not significant)</span>

<span class="sd">        See PS3.8, 7.3-4 and 9.3.8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_released</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">abort_assoc</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="mh">0x00</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Add short delay to ensure everything shuts down</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Association.run"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The main Association control.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># When the AE is acting as an SCP (Association Acceptor)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;Acceptor&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_as_acceptor</span><span class="p">()</span>
        <span class="c1"># If the local AE initiated the Association</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s1">&#39;Requestor&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_as_requestor</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_run_as_acceptor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run as an Association Acceptor.&quot;&quot;&quot;</span>
        <span class="c1"># FIXME: needed because of some thread-related problem</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Got an A-ASSOCIATE request primitive from the DICOM UL</span>
        <span class="n">assoc_rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">receive_pdu</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">acse_timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assoc_rq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># (Optionally) send an A-ABORT/A-P-ABORT in response</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_abort_assoc_rq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">abort_assoc</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_p_abort_assoc_rq</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">abort_assoc</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># If the remote AE initiated the Association then reject it if:</span>
        <span class="c1"># Rejection reasons:</span>
        <span class="c1">#   a) DUL user</span>
        <span class="c1">#       0x02 unsupported application context name</span>
        <span class="c1">#   b) DUL ACSE related</span>
        <span class="c1">#       0x01 no reason given</span>
        <span class="c1">#       0x02 protocol version not supported</span>
        <span class="c1">#   c) DUL Presentation related</span>
        <span class="c1">#       0x01 temporary congestion</span>

        <span class="c1">## DUL User Related Rejections</span>
        <span class="c1">#</span>
        <span class="c1"># [result, source, diagnostic]</span>
        <span class="n">reject_assoc_rsd</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Calling AE Title not recognised</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">require_calling_aet</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">require_calling_aet</span> <span class="o">!=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">calling_ae_title</span><span class="p">:</span>
            <span class="n">reject_assoc_rsd</span> <span class="o">=</span> <span class="p">[(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)]</span>

        <span class="c1"># Called AE Title not recognised</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">require_called_aet</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">require_called_aet</span> <span class="o">!=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">called_ae_title</span><span class="p">:</span>
            <span class="n">reject_assoc_rsd</span> <span class="o">=</span> <span class="p">[(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">)]</span>

        <span class="c1">## DUL ACSE Related Rejections</span>
        <span class="c1">#</span>
        <span class="c1"># User Identity Negotiation (PS3.7 Annex D.3.3.7)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">user_information</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">UserIdentityNegotiation</span><span class="p">):</span>
                <span class="c1"># Used to notify the association acceptor of the user</span>
                <span class="c1">#   identity of the association requestor. It may also</span>
                <span class="c1">#   request that the Acceptor response with the server</span>
                <span class="c1">#   identity.</span>
                <span class="c1">#</span>
                <span class="c1"># The Acceptor does not provide an A-ASSOCIATE response</span>
                <span class="c1">#   unless a positive response is requested and user</span>
                <span class="c1">#   authentication succeeded. If a positive response</span>
                <span class="c1">#   was requested, the A-ASSOCIATE response shall contain</span>
                <span class="c1">#   a User Identity sub-item. If a Kerberos ticket is used</span>
                <span class="c1">#   the response shall include a Kerberos server ticket</span>
                <span class="c1">#</span>
                <span class="c1"># A positive response must be requested if the association</span>
                <span class="c1">#   requestor requires confirmation. If the Acceptor does</span>
                <span class="c1">#   not support user identification it will accept the</span>
                <span class="c1">#   association without making a positive response. The</span>
                <span class="c1">#   Requestor can then decide whether to proceed</span>

                <span class="c1">#user_authorised = self.ae.on_user_identity(</span>
                <span class="c1">#                       ii.UserIdentityType,</span>
                <span class="c1">#                       ii.PrimaryField,</span>
                <span class="c1">#                       ii.SecondaryField)</span>

                <span class="c1"># Associate with all requestors</span>
                <span class="n">assoc_rq</span><span class="o">.</span><span class="n">user_information</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

                <span class="c1"># Testing</span>
                <span class="c1">#if ii.PositiveResponseRequested:</span>
                <span class="c1">#    ii.ServerResponse = b&#39;&#39;</span>

        <span class="c1"># Extended Negotiation</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">user_information</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">SOPClassExtendedNegotiation</span><span class="p">):</span>
                <span class="n">assoc_rq</span><span class="o">.</span><span class="n">user_information</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="c1">## DUL Presentation Related Rejections</span>
        <span class="c1">#</span>
        <span class="c1"># Maximum number of associations reached (local-limit-exceeded)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">active_associations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">maximum_associations</span><span class="p">:</span>
            <span class="n">reject_assoc_rsd</span> <span class="o">=</span> <span class="p">[(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reject_assoc_rsd</span><span class="p">:</span>
            <span class="n">assoc_rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">reject_assoc</span><span class="p">(</span><span class="n">assoc_rq</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_rejected</span><span class="p">(</span><span class="n">assoc_rj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_rejected</span><span class="p">(</span><span class="n">assoc_rj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1">## Presentation Contexts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span> <span class="o">=</span> <span class="n">PresentationContextManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">requestor_contexts</span> <span class="o">=</span> \
                            <span class="n">assoc_rq</span><span class="o">.</span><span class="n">presentation_context_definition_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">acceptor_contexts</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">presentation_contexts_scp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">rejected_contexts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">rejected</span>

        <span class="c1"># Save the peer AE details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;ae_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">calling_ae_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;called_aet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">called_ae_title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;pdv_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">maximum_length_received</span>
        <span class="n">peer_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_socket</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peer_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">local_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Set maximum PDU send length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peer_max_pdu</span> <span class="o">=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">maximum_length_received</span> <span class="c1"># TODO: Remove?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">maximum_pdu_size</span> <span class="o">=</span> <span class="n">assoc_rq</span><span class="o">.</span><span class="n">maximum_length_received</span>

        <span class="c1"># Set Responding AE title</span>
        <span class="n">assoc_rq</span><span class="o">.</span><span class="n">called_ae_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">ae_title</span>

        <span class="c1"># Set maximum PDU receive length</span>
        <span class="n">assoc_rq</span><span class="o">.</span><span class="n">maximum_length_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_max_pdu</span> <span class="c1"># TODO: Rename?</span>
        <span class="c1">#for user_item in assoc_rq.user_information:</span>
        <span class="c1">#    if isinstance(user_item, MaximumLengthNegotiation):</span>
        <span class="c1">#        user_item.maximum_length_received = self.local_max_pdu</span>

        <span class="c1"># Issue the A-ASSOCIATE indication (accept) primitive using the ACSE</span>
        <span class="c1"># FIXME: Is this correct? Do we send Accept then Abort if no</span>
        <span class="c1">#   presentation contexts?</span>
        <span class="n">assoc_ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accept_assoc</span><span class="p">(</span><span class="n">assoc_rq</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assoc_ac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#self.abort()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Callbacks/Logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_accepted</span><span class="p">(</span><span class="n">assoc_ac</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_accepted</span><span class="p">(</span><span class="n">assoc_ac</span><span class="p">)</span>

        <span class="c1"># No valid presentation contexts, abort the association</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">abort_assoc</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Assocation established OK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Start the SCP loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_as_acceptor_loop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_as_acceptor_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the Association Acceptor reactor loop.</span>

<span class="sd">        Main SCP run loop</span>
<span class="sd">        1. Checks for incoming DIMSE messages</span>
<span class="sd">            If DIMSE message then run corresponding service class&#39; SCP</span>
<span class="sd">            method</span>
<span class="sd">        2. Checks for peer A-RELEASE request primitive</span>
<span class="sd">            If present then kill thread</span>
<span class="sd">        3. Checks for peer A-ABORT request primitive</span>
<span class="sd">            If present then kill thread</span>
<span class="sd">        4. Checks DUL provider still running</span>
<span class="sd">            If not then kill thread</span>
<span class="sd">        5. Checks DUL idle timeout</span>
<span class="sd">            If timed out then kill thread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;requestor&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ae_title&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;ae_title&#39;</span><span class="p">],</span>
                <span class="s1">&#39;called_aet&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;called_aet&#39;</span><span class="p">],</span>
                <span class="s1">&#39;port&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                <span class="s1">&#39;address&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">],</span>
            <span class="p">},</span>
            <span class="s1">&#39;acceptor&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ae_title&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;ae_title&#39;</span><span class="p">],</span>
                <span class="s1">&#39;address&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">],</span>
                <span class="s1">&#39;port&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

            <span class="c1"># Check with the DIMSE provider for incoming messages</span>
            <span class="c1">#   all messages should be a DIMSEMessage subclass</span>
            <span class="n">msg</span><span class="p">,</span> <span class="n">msg_context_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># DIMSE message received</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                <span class="c1"># Use the Message&#39;s Affected SOP Class UID to create a new</span>
                <span class="c1">#   SOP Class instance, if there&#39;s no AffectedSOPClassUID</span>
                <span class="c1">#   then we received a C-CANCEL request</span>
                <span class="c1"># FIXME</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;AffectedSOPClassUID&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="n">sop_class</span> <span class="o">=</span> <span class="n">uid_to_sop_class</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span><span class="p">)()</span>

                <span class="c1"># Check that the SOP Class is supported by the AE</span>
                <span class="c1"># New method</span>
                <span class="n">pc_accepted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span>
                <span class="n">context</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">pc</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">pc_accepted</span> <span class="k">if</span> <span class="n">pc</span><span class="o">.</span><span class="n">context_id</span> <span class="o">==</span> <span class="n">msg_context_id</span>
                <span class="p">]</span>

                <span class="c1"># Matching context</span>
                <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
                    <span class="n">sop_class</span><span class="o">.</span><span class="n">presentation_context</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No matching presentation context</span>
                    <span class="k">pass</span>

                <span class="c1"># Old method</span>
                <span class="c1"># TODO: Index contexts in a dict using context ID</span>
                <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span> <span class="o">==</span> <span class="n">msg_context_id</span><span class="p">:</span>
                        <span class="n">sop_class</span><span class="o">.</span><span class="n">maxpdulength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_max_pdu</span>
                        <span class="n">sop_class</span><span class="o">.</span><span class="n">DIMSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span>
                        <span class="n">sop_class</span><span class="o">.</span><span class="n">ACSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span>
                        <span class="n">sop_class</span><span class="o">.</span><span class="n">AE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span>

                        <span class="c1"># Run SOPClass in SCP mode</span>
                        <span class="n">sop_class</span><span class="o">.</span><span class="n">SCP</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received message with invalid or rejected &quot;</span>
                                <span class="s2">&quot;context ID </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg_context_id</span><span class="p">)</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Check for release request</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">CheckRelease</span><span class="p">():</span>
                <span class="c1"># Callback trigger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_released</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_released</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

            <span class="c1"># Check for abort</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">CheckAbort</span><span class="p">():</span>
                <span class="c1"># Callback trigger</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_aborted</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_aborted</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

            <span class="c1"># Check if the DULServiceProvider thread is still running</span>
            <span class="c1">#   DUL.is_alive() is inherited from threading.thread</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

            <span class="c1"># Check if idle timer has expired</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">idle_timer_expired</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_as_requestor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run as the Association Requestor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">presentation_contexts_scu</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No presentation contexts set for the SCU&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Build role extended negotiation - FIXME - needs updating</span>
        <span class="c1">#   in particular, when running a C-GET user the role selection</span>
        <span class="c1">#   needs to be set prior to association</span>
        <span class="c1">#</span>
        <span class="c1"># SCP/SCU Role Negotiation (optional)</span>
        <span class="c1">#self.ext_neg = []</span>
        <span class="c1">#for context in self.AE.presentation_contexts_scu:</span>
        <span class="c1">#    tmp = SCP_SCU_RoleSelectionParameters()</span>
        <span class="c1">#    tmp.SOPClassUID = context.abstract_syntax</span>
        <span class="c1">#    tmp.SCURole = 0</span>
        <span class="c1">#    tmp.SCPRole = 1</span>
        <span class="c1">#</span>
        <span class="c1">#    self.ext_neg.append(tmp)</span>

        <span class="n">local_ae</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;address&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
                    <span class="s1">&#39;ae_title&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">ae_title</span><span class="p">}</span>

        <span class="c1"># Request an Association via the ACSE</span>
        <span class="n">is_accepted</span><span class="p">,</span> <span class="n">assoc_rsp</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">request_assoc</span><span class="p">(</span><span class="n">local_ae</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">[</span><span class="s1">&#39;pdv_size&#39;</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">presentation_contexts_scu</span><span class="p">,</span>
                                        <span class="n">userspdu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_neg</span><span class="p">)</span>

        <span class="c1"># Association was accepted or rejected</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">,</span> <span class="n">A_ASSOCIATE</span><span class="p">):</span>
            <span class="c1"># Association was accepted</span>
            <span class="k">if</span> <span class="n">is_accepted</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_accepted</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_accepted</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>

                <span class="c1"># No acceptable presentation contexts</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No Acceptable Presentation Contexts&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">abort_assoc</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

                    <span class="k">return</span>

                <span class="c1"># Build supported SOP Classes for the Association</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scu_supported_sop</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">accepted_contexts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scu_supported_sop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context_id</span><span class="p">,</span>
                         <span class="n">uid_to_sop_class</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">),</span>
                         <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># Assocation established OK</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># This seems like it should be event driven rather than</span>
                <span class="c1">#   driven by a loop</span>
                <span class="c1">#</span>
                <span class="c1"># Listen for further messages from the peer</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kill</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                    <span class="c1"># Check for release request</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">CheckRelease</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_released</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># Callback trigger</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_released</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_released</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                        <span class="k">return</span>

                    <span class="c1"># Check for abort</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">CheckAbort</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># Callback trigger</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_aborted</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_aborted</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                        <span class="k">return</span>

                    <span class="c1"># Check if the DULServiceProvider thread is</span>
                    <span class="c1">#   still running. DUL.is_alive() is inherited from</span>
                    <span class="c1">#   threading.thread</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                        <span class="k">return</span>

                    <span class="c1"># Check if idle timer has expired</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">idle_timer_expired</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                        <span class="k">return</span>

            <span class="c1"># Association was rejected</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_rejected</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_rejected</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_rejected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">kill_dul</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="c1"># Association was aborted by peer</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">,</span> <span class="n">A_ABORT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_association_aborted</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_association_aborted</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">kill_dul</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Association was aborted by DUL provider</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="p">,</span> <span class="n">A_P_ABORT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_aborted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">kill_dul</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Association failed for any other reason (No peer, etc)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dul</span><span class="o">.</span><span class="n">kill_dul</span><span class="p">()</span>
            <span class="k">return</span>


    <span class="c1"># DIMSE-C services provided by the Association</span>
<div class="viewcode-block" id="Association.send_c_echo"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_c_echo">[docs]</a>    <span class="k">def</span> <span class="nf">send_c_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-ECHO request to the peer AE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_id : int, optional</span>
<span class="sd">            The message ID, must be between 0 and 65535, inclusive, (default</span>
<span class="sd">            1).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : pydicom.dataset.Dataset</span>
<span class="sd">            If the peer timed out or sent an invalid response then returns an</span>
<span class="sd">            empty Dataset. If a valid response was received from the peer then</span>
<span class="sd">            returns a Dataset containing at least a (0000,0900) Status element,</span>
<span class="sd">            and, depending on the returned Status value, may optionally contain</span>
<span class="sd">            additional elements (see DICOM Standard Part 7, Annex C).</span>

<span class="sd">            The DICOM Standard Part 7, Table 9.3-13 indicates that the Status</span>
<span class="sd">            value of a C-ECHO response &quot;shall have a value of Success&quot;. However</span>
<span class="sd">            Section 9.1.5.1.4 indicates it may have any of the following</span>
<span class="sd">            values:</span>

<span class="sd">            Success</span>

<span class="sd">              * 0x0000 - Success</span>

<span class="sd">            Failure</span>

<span class="sd">              * 0x0122 - SOP class not supported</span>
<span class="sd">              * 0x0210 - Duplicate invocation</span>
<span class="sd">              * 0x0211 - Unrecognised operation</span>
<span class="sd">              * 0x0212 - Mistyped argument</span>

<span class="sd">            As the actual status depends on the peer SCP, it shouldn&#39;t be</span>
<span class="sd">            assumed that it will be one of these.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If called without an association to a peer SCP.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no accepted Presentation Context for &#39;Verification SOP Class&#39;.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_echo</span>
<span class="sd">        dimse_primitives.C_ECHO</span>
<span class="sd">        sop_class.VerificationServiceClass</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        DICOM Standard Part 4, Annex A</span>
<span class="sd">        DICOM Standard Part 7, Sections 9.1.5, 9.3.5 and Annex C</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; assoc = ae.associate(addr, port)</span>
<span class="sd">        &gt;&gt;&gt; if assoc.is_established:</span>
<span class="sd">        &gt;&gt;&gt;     status = assoc.send_c_echo()</span>
<span class="sd">        &gt;&gt;&gt;     if status:</span>
<span class="sd">        &gt;&gt;&gt;         print(&#39;C-ECHO Response: 0x{0:04x}&#39;.format(status.Status))</span>
<span class="sd">        &gt;&gt;&gt;     assoc.release()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-ECHO without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-ECHO request&quot;</span><span class="p">)</span>

        <span class="c1"># Verification SOP Class</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">UID</span><span class="p">(</span><span class="s1">&#39;1.2.840.10008.1.1&#39;</span><span class="p">)</span>

        <span class="c1"># Get the Presentation Context we are operating under</span>
        <span class="n">context_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                <span class="n">context_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">context_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &quot;</span>
                             <span class="s2">&quot;&#39;Verification SOP Class&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Build C-STORE request primitive</span>
        <span class="c1">#   (M) Message ID</span>
        <span class="c1">#   (M) Affected SOP Class UID</span>
        <span class="n">primitive</span> <span class="o">=</span> <span class="n">C_ECHO</span><span class="p">()</span>
        <span class="n">primitive</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="n">primitive</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">uid</span>

        <span class="c1"># Send C-ECHO request to the peer via DIMSE and wait for the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">primitive</span><span class="p">,</span> <span class="n">context_id</span><span class="p">)</span>
        <span class="n">rsp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Determine validity of the response and get the status</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rsp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;DIMSE service timed out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="n">is_valid_response</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="s1">&#39;ErrorComment&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">status</span><span class="o">.</span><span class="n">ErrorComment</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">ErrorComment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Received an invalid C-ECHO response from the peer&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="Association.send_c_store"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_c_store">[docs]</a>    <span class="k">def</span> <span class="nf">send_c_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">originator_aet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">originator_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-STORE request to the peer AE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : pydicom.dataset.Dataset</span>
<span class="sd">            The DICOM dataset to send to the peer.</span>
<span class="sd">        msg_id : int, optional</span>
<span class="sd">            The message ID, must be between 0 and 65535, inclusive, (default</span>
<span class="sd">            1).</span>
<span class="sd">        priority : int, optional</span>
<span class="sd">            The C-STORE operation priority (may not be supported by the peer),</span>
<span class="sd">            one of:</span>

<span class="sd">            - 0 - Medium</span>
<span class="sd">            - 1 - High</span>
<span class="sd">            - 2 - Low (default)</span>
<span class="sd">        originator_aet : bytes, optional</span>
<span class="sd">            The AE title of the peer that invoked the C-MOVE operation for</span>
<span class="sd">            which this C-STORE sub-operation is being performed (default None).</span>
<span class="sd">        originator_id : int, optional</span>
<span class="sd">            The Message ID of the C-MOVE request primitive from which this</span>
<span class="sd">            C-STORE sub-operation is being performed (default None).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : pydicom.dataset.Dataset</span>
<span class="sd">            If the peer timed out or sent an invalid response then returns an</span>
<span class="sd">            empty Dataset. If a valid response was received from the peer then</span>
<span class="sd">            returns a Dataset containing at least a (0000,0900) Status element,</span>
<span class="sd">            and, depending on the returned Status value, may optionally contain</span>
<span class="sd">            additional elements (see DICOM Standard Part 7, Annex C).</span>

<span class="sd">            The status for the requested C-STORE operation should be one of the</span>
<span class="sd">            following, but as the value depends on the peer SCP this can&#39;t be</span>
<span class="sd">            assumed:</span>

<span class="sd">            General C-STORE (DICOM Standard Part 7, 9.1.1.1.9 and Annex C):</span>

<span class="sd">            - Success</span>

<span class="sd">              * 0x0000 - Success</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0x0117 - Invalid SOP instance</span>
<span class="sd">              * 0x0122 - SOP class not supported</span>
<span class="sd">              * 0x0124 - Not authorised</span>
<span class="sd">              * 0x0210 - Duplicate invocation</span>
<span class="sd">              * 0x0211 - Unrecognised operation</span>
<span class="sd">              * 0x0212 - Mistyped argument</span>

<span class="sd">            Storage Service Class specific (DICOM Standard Part 4, Annex</span>
<span class="sd">            B.2.3):</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0xA700 to 0xA7FF - Out of resources</span>
<span class="sd">              * 0xA900 to 0xA9FF - Data set does not match SOP class</span>
<span class="sd">              * 0xC000 to 0xCFFF - Cannot understand</span>

<span class="sd">            - Warning</span>

<span class="sd">              * 0xB000 - Coercion of data elements</span>
<span class="sd">              * 0xB006 - Element discarded</span>
<span class="sd">              * 0xB007 - Data set does not match SOP class</span>

<span class="sd">            Non-Patient Object Service Class specific (DICOM Standard Part 4,</span>
<span class="sd">            Annex GG.4.2)</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0xA700 - Out of resources</span>
<span class="sd">              * 0xA900 - Data set does not match SOP class</span>
<span class="sd">              * 0xC000 - Cannot understand</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If send_c_store is called with no established association.</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If `dataset` is missing (0008,0016) &#39;SOP Class UID&#39; or</span>
<span class="sd">            (0008,0018) &#39;SOP Instance UID&#39; elements.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no accepted Presentation Context for `dataset` exists or if</span>
<span class="sd">            unable to encode the `dataset`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_store</span>
<span class="sd">        dimse_primitives.C_STORE</span>
<span class="sd">        sop_class.StorageServiceClass</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        DICOM Standard Part 4, Annexes B, GG</span>
<span class="sd">        DICOM Standard Part 7, Sections 9.1.1, 9.3.1 and Annex C</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; ds = read_file(&#39;file-in.dcm&#39;)</span>
<span class="sd">        &gt;&gt;&gt; assoc = ae.associate(addr, port)</span>
<span class="sd">        &gt;&gt;&gt; if assoc.is_established:</span>
<span class="sd">        &gt;&gt;&gt;     status = assoc.send_c_store(ds)</span>
<span class="sd">        &gt;&gt;&gt;     if status:</span>
<span class="sd">        &gt;&gt;&gt;         print(&#39;C-STORE Response: 0x{0:04x}&#39;.format(status.Status))</span>
<span class="sd">        &gt;&gt;&gt;     assoc.release()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-STORE without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-STORE request&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the Presentation Context we are operating under</span>
        <span class="c1">#   and hence the transfer syntax to use for encoding `dataset`</span>
        <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPClassUID</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                    <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">context_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Association.send_c_store - unable to determine &quot;</span>
                             <span class="s2">&quot;Presentation Context as &quot;</span>
                             <span class="s2">&quot;Dataset has no &#39;SOP Class UID&#39; element&quot;</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Store SCU failed due to there being no valid &quot;</span>
                             <span class="s2">&quot;presentation context for the current dataset&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ex</span>

        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Association.send_c_store - no accepted Presentation &quot;</span>
                         <span class="s2">&quot; Context for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPClassUID</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Store SCU failed due to there being no accepted &quot;</span>
                         <span class="s2">&quot;presentation context for the current dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &#39;dataset&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Build C-STORE request primitive</span>
        <span class="c1">#   (M) Message ID</span>
        <span class="c1">#   (M) Affected SOP Class UID</span>
        <span class="c1">#   (M) Affected SOP Instance UID</span>
        <span class="c1">#   (M) Priority</span>
        <span class="c1">#   (U) Move Originator Application Entity Title</span>
        <span class="c1">#   (U) Move Originator Message ID</span>
        <span class="c1">#   (M) Data Set</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">C_STORE</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPClassUID</span>
        <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPInstanceUID</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">SOPInstanceUID</span>
        <span class="n">req</span><span class="o">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MoveOriginatorApplicationEntityTitle</span> <span class="o">=</span> <span class="n">originator_aet</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MoveOriginatorMessageID</span> <span class="o">=</span> <span class="n">originator_id</span>

        <span class="c1"># Encode the `dataset` using the agreed transfer syntax</span>
        <span class="c1">#   Will return None if failed to encode</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bytestream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">DataSet</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to encode the supplied Dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to encode the supplied Dataset&#39;</span><span class="p">)</span>

        <span class="c1"># Send C-STORE request to the peer via DIMSE and wait for the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">context_id</span><span class="p">)</span>
        <span class="n">rsp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Determine validity of the response and get the status</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rsp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;DIMSE service timed out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="n">is_valid_response</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span>
            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ErrorComment&#39;</span><span class="p">,</span> <span class="s1">&#39;OffendingElement&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Received an invalid C-STORE response from the peer&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">status</span></div>

<div class="viewcode-block" id="Association.send_c_find"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_c_find">[docs]</a>    <span class="k">def</span> <span class="nf">send_c_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_model</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-FIND request to the peer AE.</span>

<span class="sd">        Yields (status, identifier) pairs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : pydicom.dataset.Dataset</span>
<span class="sd">            The C-FIND request&#39;s Identifier dataset. The exact requirements for</span>
<span class="sd">            the Identifier dataset are Service Class specific (see the DICOM</span>
<span class="sd">            Standard, Part 4).</span>
<span class="sd">        msg_id : int, optional</span>
<span class="sd">            The message ID, must be between 0 and 65535, inclusive, (default</span>
<span class="sd">            1).</span>
<span class="sd">        priority : int, optional</span>
<span class="sd">            The C-FIND operation priority (may not be supported by the peer),</span>
<span class="sd">            one of:</span>

<span class="sd">            - 0 - Medium</span>
<span class="sd">            - 1 - High</span>
<span class="sd">            - 2 - Low (default)</span>

<span class="sd">        query_model : str, optional</span>
<span class="sd">            The Query/Retrieve Information Model to use, one of the following:</span>

<span class="sd">            - &#39;P&#39; - Patient Root Information Model - FIND  (default)</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.1.1</span>
<span class="sd">            - &#39;S&#39; - Study Root Information Model - FIND</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.2.1</span>
<span class="sd">            - &#39;O&#39; - Patient Study Only Information Model - FIND</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.3.1</span>
<span class="sd">            - &#39;W&#39; - Modality Worklist Information - FIND</span>
<span class="sd">              1.2.840.10008.5.1.4.31</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        status : pydicom.dataset.Dataset</span>
<span class="sd">            If the peer timed out or sent an invalid response then yields an</span>
<span class="sd">            empty Dataset. If a response was received from the peer then</span>
<span class="sd">            yields a Dataset containing at least a (0000,0900) Status element,</span>
<span class="sd">            and depending on the returned Status value, may optionally contain</span>
<span class="sd">            additional elements (see PS3.7 9.1.2.1.5 and Annex C).</span>

<span class="sd">            The status for the requested C-FIND operation should be one of the</span>
<span class="sd">            following Status objects/codes, but as the returned value depends</span>
<span class="sd">            on the peer this can&#39;t be assumed:</span>

<span class="sd">            General C-FIND (PS3.7 9.1.2.1.5 and Annex C)</span>

<span class="sd">            - Cancel</span>

<span class="sd">              * 0xFE00 - Matching terminated due to Cancel request</span>

<span class="sd">            - Success</span>

<span class="sd">              * 0x0000 - Matching is complete: no final Identifier is supplied</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0x0122 - SOP class not supported</span>

<span class="sd">            Query/Retrieve Service Class Specific (PS3.4 Annex C.4.1):</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0xA700 - Out of resources</span>
<span class="sd">              * 0xA900 - Identifier does not match SOP Class</span>
<span class="sd">              * 0xC000 to 0xCFFF - Unable to process</span>

<span class="sd">            - Pending</span>

<span class="sd">              * 0xFF00 - Matches are continuing: current match is supplied and</span>
<span class="sd">                any Optional Keys were supported in the same manner as Required</span>
<span class="sd">                Keys</span>
<span class="sd">              * 0xFF01 - Matches are continuing: warning that one or more</span>
<span class="sd">                Optional Keys were not supported for existence and/or matching</span>
<span class="sd">                for this Identifier)</span>

<span class="sd">        identifier : pydicom.dataset.Dataset or None</span>
<span class="sd">            If the status is &#39;Pending&#39; then the C-FIND response&#39;s Identifier</span>
<span class="sd">            dataset. If the status is not &#39;Pending&#39; this will be None. The</span>
<span class="sd">            exact contents of the response Identifier are Service Class</span>
<span class="sd">            specific (see the DICOM Standard, Part 4).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If send_c_find is called with no established association.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no accepted Presentation Context for `dataset` exists or if</span>
<span class="sd">            unable to encode the Identifier `dataset`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_find</span>
<span class="sd">        dimse_primitives.C_FIND</span>
<span class="sd">        sop_class.QueryRetrieveFindServiceClass</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        DICOM Standard Part 4, Annex C</span>
<span class="sd">        DICOM Standard Part 7, Sections 9.1.2, 9.3.2 and Annex C</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-FIND without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-FIND request&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">ModalityWorklistInformationFind</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientRootQueryRetrieveInformationModelFind</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">StudyRootQueryRetrieveInformationModelFind</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientStudyOnlyQueryRetrieveInformationModelFind</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Association.send_c_find - &#39;query_model&#39; &quot;</span>
                             <span class="s2">&quot;must be &#39;W&#39;, &#39;P&#39;, &#39;S&#39; or &#39;O&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the Presentation Context we are operating under</span>
        <span class="c1">#   and hence the transfer syntax to use for encoding `dataset`</span>
        <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">context_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Find SCU failed due to there being no accepted &quot;</span>
                         <span class="s2">&quot;presentation context for the current dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &#39;dataset&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Build C-FIND request primitive</span>
        <span class="c1">#   (M) Message ID</span>
        <span class="c1">#   (M) Affected SOP Class UID</span>
        <span class="c1">#   (M) Priority</span>
        <span class="c1">#   (M) Identifier</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">C_FIND</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span>
        <span class="n">req</span><span class="o">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">priority</span>

        <span class="c1"># Encode the Identifier `dataset` using the agreed transfer syntax</span>
        <span class="c1">#   Will return None if failed to encode</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bytestream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">Identifier</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to encode the supplied Dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to encode the supplied Dataset&#39;</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Find SCU Request Identifiers:&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Send C-FIND request to the peer via DIMSE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">context_id</span><span class="p">)</span>

        <span class="c1"># Get the responses from the peer</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Wait for C-FIND response</span>
            <span class="n">rsp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># If no response received, start loop again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rsp</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Connection closed or timed-out&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">rsp</span><span class="o">.</span><span class="n">is_valid_response</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Received an invalid C-FIND response from &#39;</span> \
                             <span class="s1">&#39;the peer&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Status may be &#39;Failure&#39;, &#39;Cancel&#39;, &#39;Success&#39; or &#39;Pending&#39;</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
            <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span>
            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;OffendingElement&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrorComment&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span>

            <span class="n">status_category</span> <span class="o">=</span> <span class="n">code_to_category</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>

            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Find SCP Response: </span><span class="si">{2}</span><span class="s1"> (0x</span><span class="si">{0:04x}</span><span class="s1"> - </span><span class="si">{1}</span><span class="s1">)&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span> <span class="n">status_category</span><span class="p">,</span> <span class="n">ii</span><span class="p">))</span>

            <span class="c1"># We want to exit the wait loop if we receive a Failure, Cancel or</span>
            <span class="c1">#   Success status type</span>
            <span class="k">if</span> <span class="n">status_category</span> <span class="o">!=</span> <span class="s1">&#39;Pending&#39;</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>

            <span class="c1"># Status must be Pending, so decode the Identifier dataset</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">Identifier</span><span class="p">,</span>
                                    <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                                    <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to decode the received Identifier dataset&quot;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="kc">None</span>

            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span>

        <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span></div>

<div class="viewcode-block" id="Association.send_c_move"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_c_move">[docs]</a>    <span class="k">def</span> <span class="nf">send_c_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">move_aet</span><span class="p">,</span> <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">query_model</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-MOVE request to the peer AE.</span>

<span class="sd">        Yields (status, identifier) pairs.</span>

<span class="sd">        The ApplicationEntity.on_c_store callback should be implemented prior</span>
<span class="sd">        to calling send_c_move as the peer may either return any matches</span>
<span class="sd">        via a C-STORE sub-operation over the current association or request a</span>
<span class="sd">        new association over which to return any matches.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : pydicom.dataset.Dataset</span>
<span class="sd">            The C-MOVE request&#39;s Identifier dataset. The exact requirements for</span>
<span class="sd">            the Identifier dataset are Service Class specific (see the DICOM</span>
<span class="sd">            Standard, Part 4).</span>
<span class="sd">        move_aet : str</span>
<span class="sd">            The AE title of the destination for the C-STORE sub-operations</span>
<span class="sd">            performed by the peer.</span>
<span class="sd">        msg_id : int, optional</span>
<span class="sd">            The message ID, must be between 0 and 65535, inclusive, (default</span>
<span class="sd">            1).</span>
<span class="sd">        priority : int, optional</span>
<span class="sd">            The C-MOVE operation priority (if supported by the peer), one of:</span>

<span class="sd">            - 0 - Medium</span>
<span class="sd">            - 1 - High</span>
<span class="sd">            - 2 - Low (default)</span>

<span class="sd">        query_model : str, optional</span>
<span class="sd">            The Query/Retrieve Information Model to use, one of the following:</span>
<span class="sd">                &#39;P&#39; - Patient Root Information Model - MOVE (default)</span>
<span class="sd">                    1.2.840.10008.5.1.4.1.2.1.2</span>
<span class="sd">                &#39;S&#39; - Study Root Information Model - MOVE</span>
<span class="sd">                    1.2.840.10008.5.1.4.1.2.2.2</span>
<span class="sd">                &#39;O&#39; - Patient Study Only Information Model - MOVE</span>
<span class="sd">                    1.2.840.10008.5.1.4.1.2.3.2</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        status : pydicom.dataset.Dataset</span>
<span class="sd">            If the peer timed out or sent an invalid response then yields an</span>
<span class="sd">            empty Dataset. If a response was received from the peer then</span>
<span class="sd">            yields a Dataset containing at least a (0000,0900) Status element,</span>
<span class="sd">            and depending on the returned Status value, may optionally contain</span>
<span class="sd">            additional elements (see DICOM Standard Part 7, Section 9.1.4 and</span>
<span class="sd">            Annex C).</span>

<span class="sd">            The status for the requested C-MOVE operation should be one of the</span>
<span class="sd">            following Status objects/codes, but as the returned value depends</span>
<span class="sd">            on the peer this can&#39;t be assumed:</span>

<span class="sd">            General C-MOVE (DICOM Standard Part 7, 9.1.4.1.7 and Annex C)</span>

<span class="sd">            - Cancel</span>

<span class="sd">              * 0xFE00 - Sub-operations terminated due to Cancel indication</span>

<span class="sd">            - Success</span>

<span class="sd">              * 0x0000 - Sub-operations complete: no failures</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0x0122 - SOP class not supported</span>

<span class="sd">            Query/Retrieve Service Class Specific (DICOM Standard Part 4, Annex</span>
<span class="sd">            C):</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0xA701 - Out of resources: unable to calculate number of</span>
<span class="sd">                matches</span>
<span class="sd">              * 0xA702 - Out of resources: unable to perform sub-operations</span>
<span class="sd">              * 0xA801 - Move destination unknown</span>
<span class="sd">              * 0xA900 - Identifier does not match SOP Class</span>
<span class="sd">              * 0xC000 to 0xCFFF - Unable to process</span>

<span class="sd">            - Pending</span>

<span class="sd">              * 0xFF00 - Sub-operations are continuing</span>

<span class="sd">            - Warning</span>

<span class="sd">              * 0xB000 - Sub-operations complete: one or more failures</span>

<span class="sd">        identifier : pydicom.dataset.Dataset or None</span>
<span class="sd">            If the status is &#39;Pending&#39; or &#39;Success&#39; then yields None. If the</span>
<span class="sd">            status is &#39;Warning&#39;, &#39;Failure&#39; or &#39;Cancel&#39; then yields a Dataset</span>
<span class="sd">            which should contain an (0008,0058) &#39;Failed SOP Instance UID List&#39;</span>
<span class="sd">            element, however this is not guaranteed and may return an empty</span>
<span class="sd">            Dataset.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_move</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_store</span>
<span class="sd">        dimse_primitives.C_MOVE</span>
<span class="sd">        sop_class.QueryRetrieveMoveServiceClass</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        DICOM Standard Part 4, Annex C</span>
<span class="sd">        DICOM Standard Part 7, Sections 9.1.4, 9.3.4 and Annex C</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-MOVE without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-MOVE request&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientRootQueryRetrieveInformationModelMove</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">StudyRootQueryRetrieveInformationModelMove</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientStudyOnlyQueryRetrieveInformationModelMove</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Association.send_c_move - &#39;query_model&#39; must &quot;</span>
                             <span class="s2">&quot;be &#39;P&#39;, &#39;S&#39; or &#39;O&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the Presentation Context we are operating under</span>
        <span class="c1">#   and hence the transfer syntax to use for encoding `dataset`</span>
        <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">context_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Move SCU failed due to there being no accepted &quot;</span>
                         <span class="s2">&quot;presentation context</span><span class="se">\n</span><span class="s2">   for the current dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &#39;dataset&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Build C-MOVE request primitive</span>
        <span class="c1">#   (M) Message ID</span>
        <span class="c1">#   (M) Affected SOP Class UID</span>
        <span class="c1">#   (M) Priority</span>
        <span class="c1">#   (M) Move Destination</span>
        <span class="c1">#   (M) Identifier</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">C_MOVE</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span>
        <span class="n">req</span><span class="o">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">priority</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MoveDestination</span> <span class="o">=</span> <span class="n">move_aet</span>

        <span class="c1"># Encode the Identifier `dataset` using the agreed transfer syntax;</span>
        <span class="c1">#   will return None if failed to encode</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bytestream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">Identifier</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to encode the supplied Identifier dataset&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to encode the supplied Identifier &#39;</span>
                             <span class="s1">&#39;dataset&#39;</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Move SCU Request Identifier:&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Send C-MOVE request to the peer via DIMSE and wait for the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">context_id</span><span class="p">)</span>

        <span class="c1"># Get the responses from peer</span>
        <span class="n">operation_no</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rsp</span><span class="p">,</span> <span class="n">context_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># If nothing received from the peer, try again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rsp</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Connection closed or timed-out&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Received a C-MOVE response from the peer</span>
            <span class="k">if</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_MOVE</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
                <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span>
                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ErrorComment&#39;</span><span class="p">,</span> <span class="s1">&#39;OffendingElement&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfRemainingSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfCompletedSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfFailedSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfWarningSuboperations&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span>

                <span class="c1"># If the Status is &#39;Pending&#39; then the processing of matches</span>
                <span class="c1">#   and sub-operations are initiated or continuing</span>
                <span class="c1"># If the Status is &#39;Cancel&#39;, &#39;Failure&#39;, &#39;Warning&#39; or &#39;Success&#39;</span>
                <span class="c1">#   then we are finished</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">code_to_category</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>

                <span class="c1"># Log status type</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;Pending&#39;</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Move SCP Response: </span><span class="si">%s</span><span class="s2"> (Pending)&quot;</span><span class="p">,</span> <span class="n">operation_no</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">,</span> <span class="s1">&#39;Cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">]:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Move SCP Result: (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;Failure&#39;</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Move SCP Result: (Failure - 0x</span><span class="si">%04x</span><span class="s2">)&quot;</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>

                <span class="c1"># Log number of remaining sub-operations</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sub-Operations Remaining: </span><span class="si">%s</span><span class="s2">, Completed: </span><span class="si">%s</span><span class="s2">, &quot;</span>
                            <span class="s2">&quot;Failed: </span><span class="si">%s</span><span class="s2">, Warning: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfRemainingSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfCompletedSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfFailedSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfWarningSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

                <span class="c1"># Yields - &#39;Success&#39;, &#39;Warning&#39;, &#39;Cancel&#39;, &#39;Failure&#39; are final</span>
                <span class="c1">#   yields, &#39;Pending&#39; means more to come</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;Pending&#39;</span><span class="p">:</span>
                    <span class="n">operation_no</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Identifier</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;Failure&#39;</span><span class="p">]:</span>
                    <span class="c1"># From Part 4, Annex C.4.2, responses with these statuses</span>
                    <span class="c1">#   should contain an Identifier dataset with a</span>
                    <span class="c1">#   (0008,0058) Failed SOP Instance UID List element</span>
                    <span class="c1">#   however this can&#39;t be assumed</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">identifier</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">Identifier</span><span class="p">,</span>
                                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to decode the received Identifier &quot;</span>
                                     <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span>
                <span class="k">break</span>

            <span class="c1"># Received a C-STORE request from the peer</span>
            <span class="c1">#   C-STORE requests can be over the same association for C-MOVE</span>
            <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_STORE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c_store_scp</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span>

            <span class="c1"># Received a C-CANCEL request from the peer</span>
            <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_CANCEL</span> <span class="ow">and</span> <span class="n">rsp</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">==</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="Association.send_c_get"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_c_get">[docs]</a>    <span class="k">def</span> <span class="nf">send_c_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">msg_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_model</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-GET request to the peer AE.</span>

<span class="sd">        Yields (status, identifier) pairs.</span>

<span class="sd">        The ApplicationEntity.on_c_store callback should be implemented prior</span>
<span class="sd">        to calling send_c_get as the peer will return any matches via a C-STORE</span>
<span class="sd">        sub-operation over the current association.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : pydicom.dataset.Dataset</span>
<span class="sd">            The C-GET request&#39;s Identifier dataset. The exact requirements for</span>
<span class="sd">            the Identifier dataset are Service Class specific (see the DICOM</span>
<span class="sd">            Standard, Part 4).</span>
<span class="sd">        msg_id : int, optional</span>
<span class="sd">            The message ID, must be between 0 and 65535, inclusive, (default</span>
<span class="sd">            1).</span>
<span class="sd">        priority : int, optional</span>
<span class="sd">            The C-GET operation priority (may not be supported by the peer),</span>
<span class="sd">            one of:</span>

<span class="sd">            - 0 - Medium</span>
<span class="sd">            - 1 - High</span>
<span class="sd">            - 2 - Low (default)</span>

<span class="sd">        query_model : str, optional</span>
<span class="sd">            The Query/Retrieve Information Model to use, one of the following:</span>

<span class="sd">            - &#39;P&#39; - Patient Root Information Model - GET</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.1.3 (default)</span>
<span class="sd">            - &#39;S&#39; - Study Root Information Model - GET</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.2.3</span>
<span class="sd">            - &#39;O&#39; - Patient Study Only Information Model - GET</span>
<span class="sd">              1.2.840.10008.5.1.4.1.2.3.3</span>

<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        status : pydicom.dataset.Dataset</span>
<span class="sd">            If the peer timed out or sent an invalid response then yields an</span>
<span class="sd">            empty Dataset. If a response was received from the peer then yields</span>
<span class="sd">            a Dataset containing at least a (0000,0900) Status element, and</span>
<span class="sd">            depending on the returned Status value may optionally contain</span>
<span class="sd">            additional elements (see DICOM Standard Part 7, Section 9.1.2.1.5</span>
<span class="sd">            and Annex C).</span>

<span class="sd">            The status for the requested C-GET operation should be one of the</span>
<span class="sd">            following Status codes, but as the returned value depends on the</span>
<span class="sd">            peer this can&#39;t be assumed:</span>

<span class="sd">            General C-GET (DICOM Standard Part 7, Section 9.1.3 and Annex C)</span>

<span class="sd">            - Success</span>

<span class="sd">              * 0x0000 - Sub-operations complete: no failures or warnings</span>

<span class="sd">            - Failure</span>

<span class="sd">              * 0x0122 - SOP class not supported</span>
<span class="sd">              * 0x0124 - Not authorised</span>
<span class="sd">              * 0x0210 - Duplicate invocation</span>
<span class="sd">              * 0x0211 - Unrecognised operation</span>
<span class="sd">              * 0x0212 - Mistyped argument</span>

<span class="sd">            Query/Retrieve Service Class Specific (DICOM Standard Part 4, Annex</span>
<span class="sd">            C.4.3):</span>

<span class="sd">            - Pending</span>

<span class="sd">              * 0xFF00 - Sub-operations are continuing</span>

<span class="sd">            - Cancel</span>

<span class="sd">              * 0xFE00 - Sub-operations terminated due to Cancel indication</span>

<span class="sd">            - Failure</span>

<span class="sd">              *  0xA701 - Out of resources: unable to calculate number of</span>
<span class="sd">                 matches</span>
<span class="sd">              *  0xA702 - Out of resources: unable to perform sub-operations</span>
<span class="sd">              *  0xA900 - Identifier does not match SOP class</span>
<span class="sd">              *  0xC000 to 0xCFFF - Unable to process</span>

<span class="sd">            - Warning</span>

<span class="sd">              *  0xB000 - Sub-operations completed: one or more failures or</span>
<span class="sd">                 warnings</span>

<span class="sd">        identifier : pydicom.dataset.Dataset or None</span>
<span class="sd">            If the status is &#39;Pending&#39; or &#39;Success&#39; then yields None. If the</span>
<span class="sd">            status is &#39;Warning&#39;, &#39;Failure&#39; or &#39;Cancel&#39; then yields a Dataset</span>
<span class="sd">            which should contain an (0008,0058) &#39;Failed SOP Instance UID List&#39;</span>
<span class="sd">            element, however this is not guaranteed and may return an empty</span>
<span class="sd">            Dataset.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If send_c_get is called with no established association.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no accepted Presentation Context for `dataset` exists or if</span>
<span class="sd">            unable to encode the Identifier `dataset`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_get</span>
<span class="sd">        applicationentity.ApplicationEntity.on_c_store</span>
<span class="sd">        sop_class.QueryRetrieveGetServiceClass</span>
<span class="sd">        dimse_primitives.C_GET</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        DICOM Standard Part 4, Annex C</span>
<span class="sd">        DICOM Standard Part 7, Sections 9.1.3, 9.3.3 and Annex C</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-GET without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-GET request&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientRootQueryRetrieveInformationModelGet</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">StudyRootQueryRetrieveInformationModelGet</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">query_model</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
            <span class="n">sop_class</span> <span class="o">=</span> <span class="n">PatientStudyOnlyQueryRetrieveInformationModelGet</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Association.send_c_get() query_model &quot;</span>
                             <span class="s2">&quot;must be &#39;P&#39;, &#39;S&#39; or &#39;O&#39;]&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the Presentation Context we are operating under</span>
        <span class="c1">#   and hence the transfer syntax to use for encoding `dataset`</span>
        <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">context_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Get SCU failed due to there being no accepted &quot;</span>
                         <span class="s2">&quot;presentation context for the current dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for &#39;dataset&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Build C-GET request primitive</span>
        <span class="c1">#   (M) Message ID</span>
        <span class="c1">#   (M) Affected SOP Class UID</span>
        <span class="c1">#   (M) Priority</span>
        <span class="c1">#   (M) Identifier</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">C_GET</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">msg_id</span>
        <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">UID</span>
        <span class="n">req</span><span class="o">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">priority</span>

        <span class="c1"># Encode the Identifier `dataset` using the agreed transfer syntax</span>
        <span class="c1">#   Will return None if failed to encode</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bytestream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">req</span><span class="o">.</span><span class="n">Identifier</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">bytestream</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to encode the supplied Identifier dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to encode the supplied Identifer &#39;</span>
                             <span class="s1">&#39;dataset&#39;</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get SCU Request Identifier:&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Send C-GET request to the peer via DIMSE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">context_id</span><span class="p">)</span>

        <span class="c1"># Get the responses from the peer</span>
        <span class="n">operation_no</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Wait for DIMSE message, may be either a C-GET response or a</span>
            <span class="c1">#   C-STORE request</span>
            <span class="n">rsp</span><span class="p">,</span> <span class="n">context_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">receive_msg</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># If nothing received from the peer, try again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rsp</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Connection closed or timed-out&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Received a C-GET response from the peer</span>
            <span class="k">if</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_GET</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
                <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span>
                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ErrorComment&#39;</span><span class="p">,</span> <span class="s1">&#39;OffendingElement&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfRemainingSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfCompletedSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfFailedSuboperations&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;NumberOfWarningSuboperations&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span>

                <span class="c1"># If the Status is &#39;Pending&#39; then the processing of</span>
                <span class="c1">#   matches and sub-operations are initiated or continuing</span>
                <span class="c1"># If the Status is &#39;Cancel&#39;, &#39;Failure&#39;, &#39;Warning&#39; or &#39;Success&#39;</span>
                <span class="c1">#   then we are finished</span>
                <span class="n">category</span> <span class="o">=</span> <span class="n">code_to_category</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>

                <span class="c1"># Log status type</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;Pending&#39;</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get SCP Response: </span><span class="si">%s</span><span class="s2"> (Pending)&quot;</span><span class="p">,</span> <span class="n">operation_no</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">,</span> <span class="s1">&#39;Cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">]:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get SCP Result: (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;Failure&quot;</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Get SCP Result: (Failure - 0x</span><span class="si">%04x</span><span class="s1">)&#39;</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>

                <span class="c1"># Log number of remaining sub-operations</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sub-Operations Remaining: </span><span class="si">%s</span><span class="s2">, Completed: </span><span class="si">%s</span><span class="s2">, &quot;</span>
                            <span class="s2">&quot;Failed: </span><span class="si">%s</span><span class="s2">, Warning: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfRemainingSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfCompletedSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfFailedSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                            <span class="n">rsp</span><span class="o">.</span><span class="n">NumberOfWarningSuboperations</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

                <span class="c1"># Yields - &#39;Success&#39;, &#39;Warning&#39;, &#39;Failure&#39;, &#39;Cancel&#39; are</span>
                <span class="c1">#   final yields, &#39;Pending&#39; means more to come</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Pending&#39;</span><span class="p">]:</span>
                    <span class="n">operation_no</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Identifier</span> <span class="ow">and</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;Failure&#39;</span><span class="p">]:</span>
                    <span class="c1"># From Part 4, Annex C.4.3, responses with these statuses</span>
                    <span class="c1">#   should contain an Identifier dataset with a</span>
                    <span class="c1">#   (0008,0058) Failed SOP Instance UID List element</span>
                    <span class="c1">#   however this can&#39;t be assumed</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">identifier</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">Identifier</span><span class="p">,</span>
                                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                                            <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>

                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# DICOM Dataset&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">identifier</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to decode the received Identifier &quot;</span>
                                     <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

                <span class="k">yield</span> <span class="n">status</span><span class="p">,</span> <span class="n">identifier</span>
                <span class="k">break</span>

            <span class="c1"># Received a C-STORE request from the peer</span>
            <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_STORE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_c_store_scp</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span>

            <span class="c1"># Received a C-CANCEL request from the peer</span>
            <span class="k">elif</span> <span class="n">rsp</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">C_CANCEL</span> <span class="ow">and</span> <span class="n">rsp</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">==</span> <span class="n">msg_id</span><span class="p">:</span>
                <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_c_store_scp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A C-STORE SCP implementation.</span>

<span class="sd">        Handles C-STORE requests from the peer over the same assocation as the</span>
<span class="sd">        local AE sent a C-MOVE or C-GET request.</span>

<span class="sd">        Must always send a C-STORE response back to the peer.</span>

<span class="sd">        C-STORE Request</span>
<span class="sd">        ---------------</span>
<span class="sd">        Parameters</span>
<span class="sd">        ~~~~~~~~~~</span>
<span class="sd">        (M) Message ID</span>
<span class="sd">        (M) Affected SOP Class UID</span>
<span class="sd">        (M) Affected SOP Instance UID</span>
<span class="sd">        (M) Priority</span>
<span class="sd">        (U) Move Originator Application Entity Title</span>
<span class="sd">        (U) Move Originator Message ID</span>
<span class="sd">        (M) Data Set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        req : dimse_primitives.C_STORE</span>
<span class="sd">            The C-STORE request primitive received from the peer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build C-STORE response primitive</span>
        <span class="c1">#   (U) Message ID</span>
        <span class="c1">#   (M) Message ID Being Responded To</span>
        <span class="c1">#   (U) Affected SOP Class UID</span>
        <span class="c1">#   (U) Affected SOP Instance UID</span>
        <span class="c1">#   (M) Status</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">C_STORE</span><span class="p">()</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">MessageID</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">MessageIDBeingRespondedTo</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">AffectedSOPInstanceUID</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPInstanceUID</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span>

        <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acse</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No accepted Presentation Context for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="n">req</span><span class="o">.</span><span class="n">AffectedSOPClassUID</span><span class="p">)</span>
            <span class="c1"># SOP Class not supported, no context ID?</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mh">0x0122</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Attempt to decode the dataset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">DataSet</span><span class="p">,</span>
                        <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_implicit_VR</span><span class="p">,</span>
                        <span class="n">transfer_syntax</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to decode the received dataset&#39;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mh">0xC210</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">ErrorComment</span> <span class="o">=</span> <span class="s1">&#39;Unable to decode the dataset&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;acceptor&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ae</span><span class="p">,</span>
            <span class="s1">&#39;requestor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peer_ae</span><span class="p">,</span>
            <span class="s1">&#39;parameters&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;message_id&#39;</span> <span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">MessageID</span><span class="p">,</span>
                <span class="s1">&#39;priority&#39;</span> <span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">Priority</span><span class="p">,</span>
                <span class="s1">&#39;originator_aet&#39;</span> <span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">MoveOriginatorApplicationEntityTitle</span><span class="p">,</span>
                <span class="s1">&#39;original_message_id&#39;</span> <span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">MoveOriginatorMessageID</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">#  Attempt to run the ApplicationEntity&#39;s on_c_store callback</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae</span><span class="o">.</span><span class="n">on_c_store</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception in the &quot;</span>
                         <span class="s2">&quot;ApplicationEntity.on_c_store() callback&quot;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mh">0xC211</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check the callback&#39;s returned status</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Status&#39;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
                <span class="c1"># For the elements in the status dataset, try and set</span>
                <span class="c1">#   the corresponding response primitive attribute</span>
                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">keyword</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">keyword</span><span class="p">,</span> <span class="n">elem</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Status dataset returned by &quot;</span>
                                       <span class="s2">&quot;callback contained an &quot;</span>
                                       <span class="s2">&quot;unsupported element &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                                       <span class="n">elem</span><span class="o">.</span><span class="n">keyword</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;User callback returned a `Dataset` &quot;</span>
                             <span class="s2">&quot;without a Status element.&quot;</span><span class="p">)</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mh">0xC001</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid status returned by user callback.&quot;</span><span class="p">)</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="o">=</span> <span class="mh">0xC002</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rsp</span><span class="o">.</span><span class="n">Status</span> <span class="ow">in</span> <span class="n">STORAGE_SERVICE_CLASS_STATUS</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown status value returned by callback &quot;</span>
                           <span class="s2">&quot;- 0x</span><span class="si">{0:04x}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">Status</span><span class="p">))</span>

        <span class="c1"># Send C-STORE confirmation back to peer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">context_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_send_c_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send a C-CANCEL-* request to the peer AE.</span>

<span class="sd">        See PS3.7 9.3.2.3</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg_id : int</span>
<span class="sd">            The message ID of the C-GET/MOVE/FIND operation we want to cancel.</span>
<span class="sd">            Must be between 0 and 65535, inclusive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send a C-CANCEL without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending a C-CANCEL request.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># FIXME: Add more detail to exception</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;msg_id must be an integer.&quot;</span><span class="p">)</span>

        <span class="c1"># FIXME: Add validity checks to msg_id value</span>

        <span class="c1"># Build C-CANCEL primitive</span>
        <span class="n">primitive</span> <span class="o">=</span> <span class="n">C_CANCEL</span><span class="p">()</span>
        <span class="n">primitive</span><span class="o">.</span><span class="n">MessageIDBeingRespondedTo</span> <span class="o">=</span> <span class="n">msg_id</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sending C-CANCEL&#39;</span><span class="p">)</span>

        <span class="c1"># Send C-CANCEL request</span>
        <span class="c1"># FIXME: need context ID, not msg ID. maybe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimse</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">primitive</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>


    <span class="c1"># DIMSE-N services provided by the Association</span>
    <span class="c1"># TODO: Implement DIMSE-N services</span>
<div class="viewcode-block" id="Association.send_n_event_report"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_event_report">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_event_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-EVENT-REPORT request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-EVENT-REPORT without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-EVENT-REPORT &quot;</span>
                               <span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Association.send_n_get"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_get">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-GET request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-GET without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-GET &quot;</span>
                               <span class="s2">&quot;request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Association.send_n_set"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_set">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-SET request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-SET without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-SET &quot;</span>
                               <span class="s2">&quot;request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Association.send_n_action"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_action">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-ACTION request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-ACTION without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-ACTION &quot;</span>
                               <span class="s2">&quot;request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Association.send_n_create"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_create">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-CREATE request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-CREATE without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-CREATE &quot;</span>
                               <span class="s2">&quot;request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Association.send_n_delete"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.send_n_delete">[docs]</a>    <span class="k">def</span> <span class="nf">send_n_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send an N-DELETE request message to the peer AE.&quot;&quot;&quot;</span>
        <span class="c1"># Can&#39;t send an N-DELETE without an Association</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The association with a peer SCP must be &quot;</span>
                               <span class="s2">&quot;established before sending an N-DELETE &quot;</span>
                               <span class="s2">&quot;request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="c1"># Association logging/debugging functions</span>
<div class="viewcode-block" id="Association.debug_association_requested"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.debug_association_requested">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_association_requested</span><span class="p">(</span><span class="n">primitive</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debugging information when an A-ASSOCIATE request received.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        primitive : pynetdicom3.pdu_primitives.A_ASSOCIATE</span>
<span class="sd">            The A-ASSOCIATE (RQ) PDU received from the DICOM Upper Layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Association.debug_association_accepted"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.debug_association_accepted">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_association_accepted</span><span class="p">(</span><span class="n">primitive</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debugging information when an A-ASSOCIATE accept is received.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        primitive : pynetdicom3.pdu_primitives.A_ASSOCIATE</span>
<span class="sd">            The A-ASSOCIATE (AC) PDU received from the DICOM Upper Layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Association.debug_association_rejected"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.debug_association_rejected">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_association_rejected</span><span class="p">(</span><span class="n">primitive</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debugging information when an A-ASSOCIATE rejection received.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        assoc_primitive : pynetdicom3.pdu_primitives.A_ASSOCIATE</span>
<span class="sd">            The A-ASSOCIATE (RJ) primitive received from the DICOM Upper Layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># See PS3.8 Section 7.1.1.9 but mainly Section 9.3.4 and Table 9-21</span>
        <span class="c1">#   for information on the result and diagnostic information</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">result_source</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">result</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">diagnostic</span>

        <span class="n">source_str</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;Service User&#39;</span><span class="p">,</span>
                      <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Service Provider (ACSE)&#39;</span><span class="p">,</span>
                      <span class="mi">3</span> <span class="p">:</span> <span class="s1">&#39;Service Provider (Presentation)&#39;</span><span class="p">}</span>

        <span class="n">reason_str</span> <span class="o">=</span> <span class="p">[{</span><span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;No reason given&#39;</span><span class="p">,</span>
                       <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Application context name not supported&#39;</span><span class="p">,</span>
                       <span class="mi">3</span> <span class="p">:</span> <span class="s1">&#39;Calling AE title not recognised&#39;</span><span class="p">,</span>
                       <span class="mi">4</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">5</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">6</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">7</span> <span class="p">:</span> <span class="s1">&#39;Called AE title not recognised&#39;</span><span class="p">,</span>
                       <span class="mi">8</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">9</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">10</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">},</span>
                      <span class="p">{</span><span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;No reason given&#39;</span><span class="p">,</span>
                       <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Protocol version not supported&#39;</span><span class="p">},</span>
                      <span class="p">{</span><span class="mi">0</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;Temporary congestion&#39;</span><span class="p">,</span>
                       <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Local limit exceeded&#39;</span><span class="p">,</span>
                       <span class="mi">3</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">4</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">5</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">6</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">,</span>
                       <span class="mi">7</span> <span class="p">:</span> <span class="s1">&#39;Reserved&#39;</span><span class="p">}]</span>

        <span class="n">result_str</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span> <span class="p">:</span> <span class="s1">&#39;Rejected Permanent&#39;</span><span class="p">,</span>
                      <span class="mi">2</span> <span class="p">:</span> <span class="s1">&#39;Rejected Transient&#39;</span><span class="p">}</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Association Rejected:&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Result: </span><span class="si">%s</span><span class="s1">, Source: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result_str</span><span class="p">[</span><span class="n">result</span><span class="p">],</span>
                     <span class="n">source_str</span><span class="p">[</span><span class="n">source</span><span class="p">])</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Reason: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reason_str</span><span class="p">[</span><span class="n">source</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">reason</span><span class="p">])</span></div>

<div class="viewcode-block" id="Association.debug_association_released"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.debug_association_released">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_association_released</span><span class="p">(</span><span class="n">primitive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debugging information when an A-RELEASE request received.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        assoc_primitive : pynetdicom3.pdu_primitives.A_RELEASE</span>
<span class="sd">            The A-RELEASE (RQ) primitive received from the DICOM Upper Layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Association Released&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Association.debug_association_aborted"><a class="viewcode-back" href="../../api.html#pynetdicom3.association.Association.debug_association_aborted">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">debug_association_aborted</span><span class="p">(</span><span class="n">primitive</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Debugging information when an A-ABORT request received.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        assoc_primitive : pynetdicom3.pdu_primitives.A_ABORT</span>
<span class="sd">            The A-ABORT (RQ) primitive received from the DICOM Upper Layer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Association Aborted&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, pynetdicom3 contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.9.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>