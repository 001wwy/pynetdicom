

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pynetdicom3.utils &mdash; pynetdicom3 0.9.1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/pynetdicom3.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/pynetdicom3.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pynetdicom3
          

          
            
            <img src="../../_static/pydicom_flat_black.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../verification_service_class.html">Verification Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../storage_service_class.html">Storage Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../query_retrieve_service_class.html">Query/Retrieve Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_worklist_service_class.html">Basic Worklist Management Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relevant_patient_service_class.html">Relevant Patient Information Query Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../substance_admin_service_class.html">Substance Administration Query Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non_patient_service_class.html">Non-Patient Object Storage Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../color_palette_service_class.html">Color Palette Query/Retrieve Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../defined_procedure_service_class.html">Defined Procedure Protocol Query/Retrieve Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hanging_protocol_service_class.html">Hanging Protocol Query/Retrieve Service Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../implant_template_service_class.html">Implant Template Query/Retrieve Service Class</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">0.9.1</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pynetdicom3</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pynetdicom3.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pynetdicom3.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Various utility functions.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>

<span class="kn">from</span> <span class="nn">pydicom.uid</span> <span class="k">import</span> <span class="n">UID</span>

<span class="kn">from</span> <span class="nn">pynetdicom3.presentation</span> <span class="k">import</span> <span class="n">PresentationContext</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pynetdicom3.utils&#39;</span><span class="p">)</span>

<span class="n">IS_PYTHON3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>


<div class="viewcode-block" id="validate_ae_title"><a class="viewcode-back" href="../../reference/generated/pynetdicom3.utils.validate_ae_title.html#pynetdicom3.utils.validate_ae_title">[docs]</a><span class="k">def</span> <span class="nf">validate_ae_title</span><span class="p">(</span><span class="n">ae_title</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a valid AE title from `ae_title`, if possible.</span>

<span class="sd">    An AE title:</span>

<span class="sd">    * Must be no more than 16 characters</span>
<span class="sd">    * Leading and trailing spaces are not significant</span>
<span class="sd">    * The characters should belong to the Default Character Repertoire</span>
<span class="sd">      excluding 0x5C (backslash) and all control characters</span>

<span class="sd">    If the supplied `ae_title` is greater than 16 characters once</span>
<span class="sd">    non-significant spaces have been removed then the returned AE title</span>
<span class="sd">    will be truncated to remove the excess characters.</span>

<span class="sd">    If the supplied `ae_title` is less than 16 characters once non-significant</span>
<span class="sd">    spaces have been removed, the spare trailing characters will be set to</span>
<span class="sd">    space (0x20)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ae_title : str or bytes</span>
<span class="sd">        The AE title to check</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or bytes</span>
<span class="sd">        A valid AE title (with the same type as the supplied `ae_title`),</span>
<span class="sd">        truncated to 16 characters if necessary. If Python 3 then only returns</span>
<span class="sd">        bytes.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `ae_title` is an empty string, contains only spaces or contains</span>
<span class="sd">        control characters or backslash</span>
<span class="sd">    TypeError</span>
<span class="sd">        If `ae_title` is not a string or bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ae_title</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">is_bytes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ae_title</span> <span class="o">=</span> <span class="n">ae_title</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

        <span class="c1"># Remove leading and trailing spaces</span>
        <span class="n">significant_characters</span> <span class="o">=</span> <span class="n">ae_title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Remove trailing nulls (required as AE titles may be padded by nulls)</span>
        <span class="c1">#   and common control chars (optional, for convenience)</span>
        <span class="n">significant_characters</span> <span class="o">=</span> <span class="n">significant_characters</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0\r\t\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Check for backslash or control characters</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">significant_characters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">category</span><span class="p">(</span><span class="n">char</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span> <span class="ow">or</span> <span class="n">char</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for an AE title; must not &quot;</span>
                                 <span class="s2">&quot;contain backslash or control characters&quot;</span><span class="p">)</span>

        <span class="c1"># AE title OK</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">significant_characters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">significant_characters</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">significant_characters</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

            <span class="k">if</span> <span class="n">is_bytes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">significant_characters</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">significant_characters</span>

        <span class="c1"># AE title too long : truncate</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">significant_characters</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_bytes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">significant_characters</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">significant_characters</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>

        <span class="c1"># AE title empty str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for an AE title; must be a &quot;</span>
                             <span class="s2">&quot;non-empty string or bytes.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid value for an AE title; must be a &quot;</span>
                        <span class="s2">&quot;non-empty string or bytes.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid value for an AE title; must be a &quot;</span>
                        <span class="s2">&quot;non-empty string or bytes.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pretty_bytes"><a class="viewcode-back" href="../../reference/generated/pynetdicom3.utils.pretty_bytes.html#pynetdicom3.utils.pretty_bytes">[docs]</a><span class="k">def</span> <span class="nf">pretty_bytes</span><span class="p">(</span><span class="n">bytestream</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">items_per_line</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                 <span class="n">max_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn the bytestring `bytestream` into a list of nicely formatted str.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bytestream : bytes or io.BytesIO</span>
<span class="sd">        The bytes to convert to a nicely formatted string list</span>
<span class="sd">    prefix : str</span>
<span class="sd">        Insert `prefix` at the start of every item in the output string list</span>
<span class="sd">    delimiter : str</span>
<span class="sd">        Delimit each of the bytes in `bytestream` using `delimiter`</span>
<span class="sd">    items_per_line : int</span>
<span class="sd">        The number of bytes in each item of the output string list.</span>
<span class="sd">    max_size : int or None</span>
<span class="sd">        The maximum number of bytes to add to the output string list. A value</span>
<span class="sd">        of None indicates that all of `bytestream` should be output.</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Append `suffix` to the end of every item in the output string list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        The output string list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bytestream</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">):</span>
        <span class="n">bytestream</span> <span class="o">=</span> <span class="n">bytestream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

    <span class="n">cutoff_output</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">byte_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytestream</span><span class="p">),</span> <span class="n">items_per_line</span><span class="p">):</span>
        <span class="c1"># chunk is a bytes in python3 and a str in python2</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">bytestream</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span> <span class="o">+</span> <span class="n">items_per_line</span><span class="p">]</span>
        <span class="n">byte_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Python 2 compatibility</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;02x&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;02x&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byte_count</span> <span class="o">&lt;=</span> <span class="n">max_size</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
            <span class="n">cutoff_output</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cutoff_output</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;Only dumping </span><span class="si">{0!s}</span><span class="s1"> bytes.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_size</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lines</span></div>


<span class="k">class</span> <span class="nc">PresentationContextManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **DEPRECATED, TO BE REMOVED**</span>

<span class="sd">    Manages the presentation contexts supplied by the association requestor and</span>
<span class="sd">    acceptor</span>

<span class="sd">    To use you should first set the `requestor_contexts` attributes using a list</span>
<span class="sd">    of PresentationContext items, then set the `acceptor_contexts` attribute</span>
<span class="sd">    using another list of PresentationContext items. The accepted contexts are</span>
<span class="sd">    then available in the `accepted` attribute while the rejected ones are in</span>
<span class="sd">    the `rejected` attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_contexts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_contexts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new PresentationContextManager.</span>

<span class="sd">        FIXME: Add Parameters section</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The list of PresentationContext objects sent by the requestor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestor_contexts</span> <span class="o">=</span> <span class="n">request_contexts</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># The list of PresentationContext objects sent by the acceptor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span> <span class="o">=</span> <span class="n">response_contexts</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">negotiate_scp_scu_role</span><span class="p">(</span><span class="n">request_context</span><span class="p">,</span> <span class="n">result_context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Negotiates the SCP/SCU role &quot;&quot;&quot;</span>
        <span class="n">result_context</span><span class="o">.</span><span class="n">_scu_role</span> <span class="o">=</span> <span class="n">request_context</span><span class="o">.</span><span class="n">_scu_role</span>
        <span class="n">result_context</span><span class="o">.</span><span class="n">_scp_role</span> <span class="o">=</span> <span class="n">request_context</span><span class="o">.</span><span class="n">_scp_role</span>
        <span class="k">return</span> <span class="n">result_context</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requestor_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Requestor&#39;s presentation contexts&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requestor_contexts</span>

    <span class="nd">@requestor_contexts</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">requestor_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contexts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Requestor&#39;s presentation contexts.</span>

<span class="sd">        Must be a list of pynetdicom3.utils.PresentationContext</span>
<span class="sd">            When the local AE is making the request this is a list of</span>
<span class="sd">            the SCUsupported SOP classes combined with the supported Transfer</span>
<span class="sd">            Syntax(es)</span>
<span class="sd">        When the peer AE is making the request this is the contents of the</span>
<span class="sd">            A-ASSOCIATE PresentationContextDefinitionList parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requestor_contexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">PresentationContext</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_requestor_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;requestor_contexts must be a list of &quot;</span>
                            <span class="s2">&quot;PresentationContext items&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acceptor_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the Acceptor&#39;s presentation contexts&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span>

    <span class="nd">@acceptor_contexts</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">acceptor_contexts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contexts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the Acceptor&#39;s presentation contexts.</span>

<span class="sd">        Must be a list of pynetdicom3.utils.PresentationContext</span>
<span class="sd">        There are two possible situations</span>
<span class="sd">          1. The local AE issues the request and receives the response</span>
<span class="sd">          2. The peer AE issues the request and the local must determine</span>
<span class="sd">           the response</span>
<span class="sd">        The first situation means that the acceptor has already decided on</span>
<span class="sd">          a Result and (if accepted) which Transfer Syntax to use</span>
<span class="sd">        The second situation means that we must determine whether to accept</span>
<span class="sd">          or reject presentation context and which Transfer Syntax to use</span>

<span class="sd">          requestor_contexts cannot be an empty list</span>
<span class="sd">        When the local AE is making the request, this is just the contents of</span>
<span class="sd">        the A-ASSOCIATE PresentationContextDefinitionResultList parameter</span>
<span class="sd">         (Result value will not be None)</span>
<span class="sd">        When the peer AE is making the request this will be the list of the</span>
<span class="sd">          SCP supported SOP classes combined with the supported Transfer</span>
<span class="sd">          Syntax(es) (Result value will be None)</span>

<span class="sd">        FIXME: This needs to be refactored, its slow and overly complex</span>
<span class="sd">        FIXME: It would be better to have a separate method to call when the</span>
<span class="sd">            user wants the contexts evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestor_contexts</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You can only set the Acceptor&#39;s presentation &quot;</span>
                               <span class="s2">&quot;contexts after the Requestor&#39;s&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;acceptor_contexts must be a list of &quot;</span>
                            <span class="s2">&quot;PresentationContext items&quot;</span><span class="p">)</span>

        <span class="c1"># Validate the supplied contexts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">PresentationContext</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;acceptor_contexts must be a list of &quot;</span>
                                <span class="s2">&quot;PresentationContext items&quot;</span><span class="p">)</span>

        <span class="c1"># Generate accepted_contexts and rejected_contexts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requestor_contexts</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># For each of the contexts available to the acceptor</span>
            <span class="k">for</span> <span class="n">ii_req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requestor_contexts</span><span class="p">:</span>
                <span class="c1"># Get the acceptor context with the same Abstract Syntax as</span>
                <span class="c1">#   the requestor context</span>
                <span class="n">acc_context</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">ii_acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acceptor_contexts</span><span class="p">:</span>
                    <span class="c1"># The acceptor context will only have an abstract syntax</span>
                    <span class="c1">#   if we are the Acceptor, otherwise we have to match</span>
                    <span class="c1">#   using the IDs</span>

                    <span class="c1"># If we are the Requestor then the Acceptor contexts</span>
                    <span class="c1">#   will have no Abstract Syntax</span>
                    <span class="k">if</span> <span class="n">ii_acc</span><span class="o">.</span><span class="n">abstract_syntax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ii_acc</span><span class="o">.</span><span class="n">abstract_syntax</span> <span class="o">==</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">:</span>
                            <span class="n">acc_context</span> <span class="o">=</span> <span class="n">ii_acc</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ii_acc</span><span class="o">.</span><span class="n">context_id</span> <span class="o">==</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">context_id</span><span class="p">:</span>
                            <span class="n">acc_context</span> <span class="o">=</span> <span class="n">ii_acc</span>
                            <span class="c1"># Set Abstract Syntax (for convenience)</span>
                            <span class="n">ii_acc</span><span class="o">.</span><span class="n">abstract_syntax</span> <span class="o">=</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">abstract_syntax</span>

                <span class="c1"># Create a new PresentationContext item that will store the</span>
                <span class="c1">#   results from the negotiation</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">PresentationContext</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">context_id</span>
                <span class="n">result</span><span class="o">.</span><span class="n">abstract_syntax</span> <span class="o">=</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">abstract_syntax</span>

                <span class="c1"># If no matching Abstract Syntax then we are the Acceptor and</span>
                <span class="c1">#   we reject the current context (0x03 - abstract syntax not</span>
                <span class="c1">#   supported)</span>
                <span class="k">if</span> <span class="n">acc_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># FIXME: make pdu not require this.</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">transfer_syntax</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii_req</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mh">0x03</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_scp_scu_role</span><span class="p">(</span><span class="n">ii_req</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                <span class="c1"># If there is a matching Abstract Syntax then check to see if</span>
                <span class="c1">#   the result is None (indicates we are the Acceptor) or</span>
                <span class="c1">#   has a value set (indicates we are the Requestor)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># We are the Acceptor and must decide to accept or reject</span>
                    <span class="c1">#   the context</span>
                    <span class="k">if</span> <span class="n">acc_context</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="c1"># Check the Transfer Syntaxes</span>
                        <span class="c1">#   We accept the first matching transfer syntax</span>
                        <span class="k">for</span> <span class="n">transfer_syntax</span> <span class="ow">in</span> <span class="n">acc_context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">:</span>
                            <span class="c1"># The local transfer syntax is used in order to</span>
                            <span class="c1">#   enforce preference based on position</span>
                            <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">in</span> <span class="n">ii_req</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">:</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">transfer_syntax</span> <span class="o">=</span> <span class="p">[</span><span class="n">transfer_syntax</span><span class="p">]</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mh">0x00</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_scp_scu_role</span><span class="p">(</span><span class="n">ii_req</span><span class="p">,</span>
                                                                     <span class="n">result</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                                <span class="k">break</span>

                        <span class="c1"># Refuse sop class because TS not supported</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># FIXME: make pdu not require this.</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">transfer_syntax</span> <span class="o">=</span> <span class="p">[</span><span class="n">transfer_syntax</span><span class="p">]</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="mh">0x04</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_scp_scu_role</span><span class="p">(</span><span class="n">ii_req</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                    <span class="c1"># We are the Requestor and the Acceptor has accepted this</span>
                    <span class="c1">#   context</span>
                    <span class="k">elif</span> <span class="n">acc_context</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
                        <span class="c1"># The accepted transfer syntax (there is only 1)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">transfer_syntax</span> <span class="o">=</span> <span class="p">[</span><span class="n">acc_context</span><span class="o">.</span><span class="n">transfer_syntax</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                        <span class="c1"># Add it to the list of accepted presentation contexts</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                    <span class="c1"># We are the Requestor and the Acceptor has rejected this</span>
                    <span class="c1">#   context</span>
                    <span class="k">elif</span> <span class="n">acc_context</span><span class="o">.</span><span class="n">result</span> <span class="ow">in</span> <span class="p">[</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">]:</span>
                        <span class="c1"># The rejected transfer syntax(es)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">transfer_syntax</span> <span class="o">=</span> <span class="n">acc_context</span><span class="o">.</span><span class="n">transfer_syntax</span>

                        <span class="c1"># Add it to the list of accepted presentation contexts</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;Result&#39; parameter in the &quot;</span>
                                         <span class="s2">&quot;Acceptor&#39;s Presentation Context list&quot;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, pynetdicom3 contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>